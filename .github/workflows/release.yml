name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0, without v prefix)'
        required: true
        type: string

concurrency:
  group: release
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  create-release-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate version format
        run: |
          if ! [[ "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi

      - name: Check tag does not exist
        run: |
          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "Error: Tag v${{ inputs.version }} already exists"
            exit 1
          fi

      - name: Check CHANGELOG has content in NEXT section
        run: |
          # Extract content between ## NEXT and the next ## heading (or EOF)
          content=$(sed -n '/^## NEXT$/,/^## /{ /^## /d; p; }' CHANGELOG.md | sed '/^$/d')
          if [ -z "$content" ]; then
            echo "Error: CHANGELOG.md has no content in the NEXT section"
            echo "Please add release notes before creating a release"
            exit 1
          fi
          echo "CHANGELOG content found:"
          echo "$content"

      - name: Update Cargo.toml versions
        run: |
          # Update client/Cargo.toml
          sed -i 's/^version = ".*"/version = "${{ inputs.version }}"/' client/Cargo.toml
          echo "Updated client/Cargo.toml:"
          grep '^version' client/Cargo.toml

          # Update server/Cargo.toml
          sed -i 's/^version = ".*"/version = "${{ inputs.version }}"/' server/Cargo.toml
          echo "Updated server/Cargo.toml:"
          grep '^version' server/Cargo.toml

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Update Cargo.lock
        run: cargo check --workspace

      - name: Process CHANGELOG.md
        id: changelog
        run: |
          # Extract the NEXT section content for release notes
          # Get content between ## NEXT and the next ## heading (or EOF)
          changelog_content=$(sed -n '/^## NEXT$/,/^## /{ /^## NEXT$/d; /^## /d; p; }' CHANGELOG.md)

          # Save to file for release notes (trim leading/trailing whitespace)
          echo "$changelog_content" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' > /tmp/release_notes.md

          # Extract [Both] and [Client] entries for addon changelog (strip prefix, convert * to -)
          grep -E '^\* \[(Both|Client)\]' CHANGELOG.md | \
            sed 's/^\* \[Both\] /- /' | \
            sed 's/^\* \[Client\] /- /' > /tmp/addon_changelog_entries.md || true

          echo "Addon changelog entries:"
          cat /tmp/addon_changelog_entries.md

          # Store in output for later job
          {
            echo 'content<<EOF'
            cat /tmp/release_notes.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

          # Update CHANGELOG.md: replace ## NEXT with version and add new NEXT section
          sed -i "s/^## NEXT$/## ${{ inputs.version }}/" CHANGELOG.md

          # Add new NEXT section at the top (after # Changelog)
          sed -i '/^# Changelog$/a\\n## NEXT\n' CHANGELOG.md

          echo "Updated CHANGELOG.md:"
          head -20 CHANGELOG.md

      - name: Commit version bump
        run: |
          git add client/Cargo.toml server/Cargo.toml Cargo.lock CHANGELOG.md
          git commit -m "chore: release v${{ inputs.version }}"

      - name: Create and push tag
        run: |
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin main
          git push origin "v${{ inputs.version }}"

      - name: Upload release artifacts
        uses: actions/upload-artifact@v5
        with:
          name: release-artifacts
          path: |
            /tmp/release_notes.md
            /tmp/addon_changelog_entries.md
          retention-days: 1

  wait-for-ci:
    name: Wait for CI Build
    runs-on: ubuntu-latest
    needs: create-release-tag
    steps:
      - uses: actions/checkout@v6

      - name: Wait for CI workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for CI workflow to start for tag v${{ inputs.version }}..."

          # Wait for workflow to start (up to 3 minutes)
          run_id=""
          for i in {1..36}; do
            run_id=$(gh run list --workflow=ci.yml --limit=20 --json headBranch,databaseId,status \
              -q '.[] | select(.headBranch == "v${{ inputs.version }}") | .databaseId' | head -1)
            if [ -n "$run_id" ]; then
              echo "Found CI run: $run_id"
              break
            fi
            echo "Waiting for CI workflow to start... ($i/36)"
            sleep 5
          done

          if [ -z "$run_id" ]; then
            echo "Error: CI workflow did not start within 3 minutes"
            exit 1
          fi

          # Wait for workflow to complete
          echo "Waiting for CI run $run_id to complete..."
          gh run watch "$run_id" --exit-status
          echo "CI workflow completed successfully!"

  update-addon-and-release:
    name: Update Addon & Create Release
    runs-on: ubuntu-latest
    needs: [create-release-tag, wait-for-ci]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Pull latest changes
        run: git pull origin main

      - name: Download release artifacts
        uses: actions/download-artifact@v6
        with:
          name: release-artifacts
          path: /tmp

      - name: Update addon/build.yaml
        run: |
          sed -i 's|CLIENT_IMAGE: ghcr.io/fkrauthan/ha-tunnel-client:.*|CLIENT_IMAGE: ghcr.io/fkrauthan/ha-tunnel-client:${{ inputs.version }}|' addon/build.yaml
          echo "Updated addon/build.yaml:"
          grep CLIENT_IMAGE addon/build.yaml

      - name: Update addon/config.yaml
        run: |
          sed -i 's/^version: ".*"/version: "${{ inputs.version }}"/' addon/config.yaml
          echo "Updated addon/config.yaml:"
          grep '^version:' addon/config.yaml

      - name: Update addon/CHANGELOG.md
        id: addon_changelog
        run: |
          if [ -s /tmp/addon_changelog_entries.md ]; then
            echo "Adding entries to addon/CHANGELOG.md:"
            cat /tmp/addon_changelog_entries.md

            # Create a temporary file with the new changelog content
            {
              echo "# Changelog"
              echo ""
              echo "## ${{ inputs.version }}"
              echo ""
              cat /tmp/addon_changelog_entries.md
              echo ""
              # Append the rest of the existing changelog (skip the # Changelog header)
              tail -n +2 addon/CHANGELOG.md
            } > /tmp/new_addon_changelog.md

            mv /tmp/new_addon_changelog.md addon/CHANGELOG.md

            echo "Updated addon/CHANGELOG.md:"
            cat addon/CHANGELOG.md
            echo "updated=true" >> "$GITHUB_OUTPUT"
          else
            echo "No addon-specific entries found, skipping addon/CHANGELOG.md update"
            echo "updated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit addon updates
        run: |
          git add addon/build.yaml addon/config.yaml
          if [ "${{ steps.addon_changelog.outputs.updated }}" = "true" ]; then
            git add addon/CHANGELOG.md
          fi
          git commit -m "chore: update addon to v${{ inputs.version }}"
          git push origin main

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ inputs.version }}" \
            --title "v${{ inputs.version }}" \
            --notes-file /tmp/release_notes.md \
            --verify-tag
