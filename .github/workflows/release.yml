name: Release
run-name: Releasing v${{ inputs.version }}

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0, without v prefix)'
        required: true
        type: string

concurrency:
  group: release
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  validate-and-prepare:
    name: Validate and Prepare Release
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          if ! [[ "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 1.0.0)"
            exit 1
          fi

      - name: Check tag does not exist
        run: |
          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "Error: Tag v${{ inputs.version }} already exists"
            exit 1
          fi

      - name: Check CHANGELOG has content in NEXT section
        run: |
          content=$(sed -n '/^## NEXT$/,/^## /{ /^## /d; p; }' CHANGELOG.md | sed '/^$/d')
          if [ -z "$content" ]; then
            echo "Error: CHANGELOG.md has no content in the NEXT section"
            echo "Please add release notes before creating a release"
            exit 1
          fi
          echo "CHANGELOG content found:"
          echo "$content"

      - name: Extract changelog content
        id: changelog
        run: |
          changelog_content=$(sed -n '/^## NEXT$/,/^## /{ /^## NEXT$/d; /^## /d; p; }' CHANGELOG.md)
          {
            echo 'content<<EOF'
            echo "$changelog_content" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Extract addon changelog entries
        run: |
          grep -E '^\* \[(Both|Client)\]' CHANGELOG.md | \
            sed 's/^\* \[Both\] /- /' | \
            sed 's/^\* \[Client\] /- /' > /tmp/addon_changelog_entries.md || true
          echo "Addon changelog entries:"
          cat /tmp/addon_changelog_entries.md

      - name: Upload changelog artifacts
        uses: actions/upload-artifact@v5
        with:
          name: changelog-artifacts
          path: /tmp/addon_changelog_entries.md
          retention-days: 1

  create-release-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    needs: validate-and-prepare
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update Cargo.toml versions
        run: |
          sed -i 's/^version = ".*"/version = "${{ inputs.version }}"/' client/Cargo.toml
          echo "Updated client/Cargo.toml:"
          grep '^version' client/Cargo.toml

          sed -i 's/^version = ".*"/version = "${{ inputs.version }}"/' server/Cargo.toml
          echo "Updated server/Cargo.toml:"
          grep '^version' server/Cargo.toml

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Update Cargo.lock
        run: cargo check --workspace

      - name: Process CHANGELOG.md
        run: |
          sed -i "s/^## NEXT$/## ${{ inputs.version }}/" CHANGELOG.md
          sed -i '/^# Changelog$/a\\n## NEXT\n' CHANGELOG.md
          echo "Updated CHANGELOG.md:"
          head -20 CHANGELOG.md

      - name: Commit version bump
        run: |
          git add client/Cargo.toml server/Cargo.toml Cargo.lock CHANGELOG.md
          git commit -m "chore: release v${{ inputs.version }}"

      - name: Create and push tag
        run: |
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin main
          git push origin "v${{ inputs.version }}"

  run-ci-main:
    name: Run CI Build - Main
    needs: create-release-tag
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/ci.yml
    with:
      ref: ${{ github.ref }}

  run-ci-tag:
    name: Run CI Build - Tag
    needs: create-release-tag
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/ci.yml
    with:
      ref: v${{ inputs.version }}

  update-addon-and-release:
    name: Update Addon & Create Release
    runs-on: ubuntu-latest
    needs: [validate-and-prepare, run-ci-tag]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Pull latest changes
        run: git pull origin main

      - name: Download changelog artifacts
        uses: actions/download-artifact@v6
        with:
          name: changelog-artifacts
          path: /tmp

      - name: Update addon/build.yaml
        run: |
          sed -i 's|CLIENT_IMAGE: ghcr.io/fkrauthan/ha-tunnel-client:.*|CLIENT_IMAGE: ghcr.io/fkrauthan/ha-tunnel-client:${{ inputs.version }}|' addon/build.yaml
          echo "Updated addon/build.yaml:"
          grep CLIENT_IMAGE addon/build.yaml

      - name: Update addon/config.yaml
        run: |
          sed -i 's/^version: ".*"/version: "${{ inputs.version }}"/' addon/config.yaml
          echo "Updated addon/config.yaml:"
          grep '^version:' addon/config.yaml

      - name: Update addon/CHANGELOG.md
        id: addon_changelog
        run: |
          if [ -s /tmp/addon_changelog_entries.md ]; then
            echo "Adding entries to addon/CHANGELOG.md:"
            cat /tmp/addon_changelog_entries.md

            {
              echo "## ${{ inputs.version }}"
              echo ""
              cat /tmp/addon_changelog_entries.md
              echo ""
              cat addon/CHANGELOG.md
            } > /tmp/new_addon_changelog.md

            mv /tmp/new_addon_changelog.md addon/CHANGELOG.md

            echo "Updated addon/CHANGELOG.md:"
            cat addon/CHANGELOG.md
            echo "updated=true" >> "$GITHUB_OUTPUT"
          else
            echo "No addon-specific entries found, skipping addon/CHANGELOG.md update"
            echo "updated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit addon updates
        run: |
          git add addon/build.yaml addon/config.yaml
          if [ "${{ steps.addon_changelog.outputs.updated }}" = "true" ]; then
            git add addon/CHANGELOG.md
          fi
          git commit -m "chore: update addon to v${{ inputs.version }}"
          git push origin main

      - name: Create release notes file
        run: |
          cat << 'EOF' > /tmp/release_notes.md
          ${{ needs.validate-and-prepare.outputs.changelog }}
          EOF

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ inputs.version }}" \
            --title "v${{ inputs.version }}" \
            --notes-file /tmp/release_notes.md \
            --verify-tag
